import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang-q79oSesm.js";import{c as p,w as l,u as c,a as g,p as k,o as y,e as F,d as e,f as i,g as s}from"./app-B-ElfUmG.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-D_w-1Q7r.js";import"./YunCard.vue_vue_type_script_setup_true_lang-DpA-Vxh0.js";import"./index-C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-DxVdgKIc.js";import"./post-BMrNNKaA.js";const u="/photo/posts/deploy-mongodb-replica-set/mongodbreplicaset.webp",m="/assets/2024-08-19-15-08-49-xqqg267Q.webp",D="/assets/2024-08-19-15-30-23-DAIIQCzd.webp",f=i("figure",null,[i("img",{src:u,alt:"MongoDB",loading:"lazy",decoding:"async"})],-1),_=i("p",null,"最近把自己的一个小项目迁移了服务器, 结果发现接口响应速度慢了很多, 排查了不少时间后突然想起来是因为新服务器和 MongoDB Atlas 不在同一个地区, 光是二者之间的网络延迟就很高.",-1),C=i("p",null,"而 MongoDB Atlas 提供的免费实例要备份数据和迁移比较麻烦, 又因为 MongoDB 单实例不支持事务, 所以决定干脆自建一个 MongoDB 副本集 😎.",-1),b=i("h2",{id:"环境",tabindex:"-1"},[s("环境 "),i("a",{class:"header-anchor",href:"#环境","aria-label":'Permalink to "环境"'},"​")],-1),E=i("div",{class:"tip custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"本文环境与前提"),i("span",{lang:"zh-CN"},"本文环境与前提")]),i("ul",null,[i("li",null,"OS: Debian Bookworm"),i("li",null,"MongoDB: 7.0.0"),i("li",null,"使用 Docker 安装 MongoDB")])],-1),v=i("p",null,[s("我手上有几台不同服务商不同地区的服务器, 下文都以 "),i("code",null,"Server A"),s(", "),i("code",null,"Server B"),s(", "),i("code",null,"Server C"),s(" 代表.")],-1),A=i("p",null,"为了申请证书, 还需要至少一个域名.",-1),B=i("h2",{id:"安装-mongodb",tabindex:"-1"},[s("安装 MongoDB "),i("a",{class:"header-anchor",href:"#安装-mongodb","aria-label":'Permalink to "安装 MongoDB"'},"​")],-1),w=i("p",null,"首先要在每台服务器上都安装 MongoDB, 这里使用 Docker Compose.",-1),S=i("div",{class:"language-yaml vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# docker-compose.yml")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"services"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  mongo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    image"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," mongo")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"  #  restart: always")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    environment"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"      MONGO_INITDB_ROOT_USERNAME"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," root")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"      MONGO_INITDB_ROOT_PASSWORD"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," password")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    ports"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      -"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," 27017:27017")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    volumes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      -"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," ./data:/data/db")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      -"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," ./config:/etc/mongo")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    command"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}}," ["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"--config"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"/etc/mongo/mongod.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"]")])])]),i("button",{class:"collapse"})],-1),x=i("p",null,[s("然后 "),i("code",null,"./config"),s(" 目录下新建我们的配置文件 "),i("code",null,"mongod.conf"),s(":")],-1),M=i("div",{class:"language-yaml vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# mongod.conf")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# for documentation of all options, see:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   http://docs.mongodb.org/manual/reference/configuration-options/")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# Where and how to store data.")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"storage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  dbPath"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /data/db")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#  engine:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#  wiredTiger:")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# network interfaces")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"net"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 27017")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  bindIp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 127.0.0.1")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# how the process runs")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"processManagement"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  timeZoneInfo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /usr/share/zoneinfo")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# where to write logging data.")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# systemLog:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   destination: file")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   logAppend: true")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   path: /var/log/mongodb/mongod.log")])])]),i("button",{class:"collapse"})],-1),T=i("p",null,"暂时只需要上面这一点配置就可以啦, 先不要启动容器, 我们还需要配置副本集之间认证用的 keyfile.",-1),P=i("h2",{id:"配置节点-keyfile",tabindex:"-1"},[s("配置节点 keyfile "),i("a",{class:"header-anchor",href:"#配置节点-keyfile","aria-label":'Permalink to "配置节点 keyfile"'},"​")],-1),N=i("h3",{id:"生成-keyfile",tabindex:"-1"},[s("生成 keyfile "),i("a",{class:"header-anchor",href:"#生成-keyfile","aria-label":'Permalink to "生成 keyfile"'},"​")],-1),R=i("p",null,[i("a",{href:"https://www.mongodb.com/zh-cn/docs/manual/core/security-internal-authentication/#std-label-internal-auth-keyfile",target:"_blank",rel:"noreferrer"},"keyFile"),s(" 用于 MongoDB 副本集节点之间的认证, 每一个节点需要有相同的 keyFile 才能加入副本集.")],-1),z=i("p",null,[s("keyFile 的内容就相当于密码啦, 用什么软件生成一个都行, 这里就使用 "),i("code",null,"openssl"),s(":")],-1),I=i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"openssl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," rand"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#C3E88D"}}," -base64"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 756"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#89DDFF"}}," >"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," keyfile")])])]),i("button",{class:"collapse"})],-1),L=i("p",null,[s("然后需要把 "),i("code",null,"keyfile"),s(" 分发到每一个节点上, 并且仅为文件所有者提供读取权限.")],-1),$=i("h3",{id:"修改-keyfile-权限",tabindex:"-1"},[s("修改 keyfile 权限 "),i("a",{class:"header-anchor",href:"#修改-keyfile-权限","aria-label":'Permalink to "修改 keyfile 权限"'},"​")],-1),V=i("p",null,[s("如果你是在本机直接安装的 MongoDB, 只需要使用 "),i("code",null,"chmod"),s(" 修改权限:")],-1),O=i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"chmod"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 400"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," keyfile")])])]),i("button",{class:"collapse"})],-1),q=i("p",null,[s("但是如果使用 Docker 安装, 不仅要把 "),i("code",null,"keyfile"),s(" 挂载到容器内, 还要进入容器来修改权限, 因为容器内部的文件权限和外面是不一样的!")],-1),W=i("p",null,[s("这里我把 keyfile 挂载到了 "),i("code",null,"/etc/mongo/keyfile")],-1),j=i("p",null,"先使用前面的配置文件直接启动容器:",-1),G=i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," compose"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," up"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#C3E88D"}}," -d")])])]),i("button",{class:"collapse"})],-1),Q=i("p",null,"然后进入容器修改权限:",-1),X=i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#C3E88D"}}," -it"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#89DDFF"}}," <"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"container_i"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"d"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#89DDFF"}},">"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /bin/bash")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"chmod"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 400"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /etc/mongo/keyfile")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"chown"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," 999:999"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /etc/mongo/keyfile")])])]),i("button",{class:"collapse"})],-1),K=i("p",null,"修改完权限后把容器停掉, 因为我们还要修改配置文件.",-1),U=i("div",{class:"tip custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"TIP"),i("span",{lang:"zh-CN"},"提示")]),i("p",null,"每一个节点都要使用相同的 keyfile 进行上面相同的操作.")],-1),Y=i("h2",{id:"配置副本集认证",tabindex:"-1"},[s("配置副本集认证 "),i("a",{class:"header-anchor",href:"#配置副本集认证","aria-label":'Permalink to "配置副本集认证"'},"​")],-1),Z=i("p",null,"配置完了所有节点的 keyfile, 现在来修改配置文件启用副本集, 依然是所有节点的配置文件都要修改.",-1),J=i("div",{class:"language-yaml vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker has-diff vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# mongod.conf")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# for documentation of all options, see:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   http://docs.mongodb.org/manual/reference/configuration-options/")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# Where and how to store data.")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"storage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  dbPath"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /data/db")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#  engine:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#  wiredTiger:")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# network interfaces")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"net"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 27017")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  bindIp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 127.0.0.1")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# how the process runs")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"processManagement"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  timeZoneInfo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /usr/share/zoneinfo")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# where to write logging data.")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# systemLog:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   destination: file")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   logAppend: true")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"#   path: /var/log/mongodb/mongod.log")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"security"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  clusterAuthMode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," keyFile")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  authorization"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," enabled")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  keyFile"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /etc/mongo/keyfile")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"replication"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  replSetName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"rs0"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}}," # 副本集名称")])])]),i("button",{class:"collapse"})],-1),H=i("p",null,"如果是同机房所有节点使用内部网络的话, 这样就可以直接启动副本集了, 但是我的节点是分布在不同地区的, 所以还需要开放外部连接.",-1),ii=i("div",{class:"language-yaml vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker has-highlighted vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#545454","--shiki-light-font-style":"inherit","--shiki-dark-font-style":"italic"}},"# mongod.conf")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"net"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 27017")]),s(`
`),i("span",{class:"line highlighted warning"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  bindIp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," 0.0.0.0")])])]),i("button",{class:"collapse"})],-1),si=i("p",null,"既然开放了外部连接, 那么就需要对传输使用 TLS 加密.",-1),li=i("h2",{id:"配置-tls",tabindex:"-1"},[s("配置 TLS "),i("a",{class:"header-anchor",href:"#配置-tls","aria-label":'Permalink to "配置 TLS"'},"​")],-1),ti=i("h3",{id:"准备证书",tabindex:"-1"},[s("准备证书 "),i("a",{class:"header-anchor",href:"#准备证书","aria-label":'Permalink to "准备证书"'},"​")],-1),ei=i("p",null,[s("使用 TLS 就需要证书, 这里使用 "),i("code",null,"Let's Encrypt"),s(" 的证书.")],-1),ai=i("p",null,"申请证书的方式和为网站申请证书一样, 这里不再赘述, 可以参考:",-1),ni=i("ul",null,[i("li",null,[i("a",{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noreferrer"},"Acme.sh Wiki")]),i("li",null,[i("a",{href:"/posts/acmessl/"},"使用ACME申请并配置SSL证书")])],-1),hi=i("div",{class:"tip custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"TIP"),i("span",{lang:"zh-CN"},"提示")]),i("p",null,"也可以使用自签名证书, 但其实自己维护一个 CA 比申请第三方 CA 的证书麻烦多了, 可以参考:"),i("ul",null,[i("li",null,[i("a",{href:"/posts/grpc-and-protobuf-in-go-tls/"},"Go 的 gRPC 和 Protocol Buffers—TLS 认证")])]),i("p",null,"而且自签名证书也不够安全.")],-1),ki=i("p",null,[s("一般来说, 申请成功证书会得到两个文件: "),i("code",null,"fullchain.pem"),s(" 和 "),i("code",null,"privkey.pem"),s(", 分别是证书链和私钥.")],-1),oi=i("p",null,[s("但是 MongoDB 还需要 CA 证书, 可以在 "),i("a",{href:"https://letsencrypt.org/certs/isrgrootx1.pem",target:"_blank",rel:"noreferrer"},"Let’s Encrypt ISRG Root X1"),s(" 下载.")],-1),ri=i("p",null,[s("接下来需要把 "),i("code",null,"fullchain.pem"),s(", "),i("code",null,"privkey.pem"),s(" '合并' 为一个文件 (MongoDB 要求的!)")],-1),di=i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#FFCB6B"}},"cat"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," fullchain.pem"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," privkey.pem"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#89DDFF"}}," >"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," mongod.pem")])])]),i("button",{class:"collapse"})],-1),pi=i("p",null,[s("其实就是把 "),i("code",null,"fullchain.pem"),s(" 和 "),i("code",null,"privkey.pem"),s(" 的内容拼接到一起, 得到的 "),i("code",null,"mongod.pem"),s(" 就是 MongoDB 需要的证书文件.")],-1),ci=i("div",{class:"tip custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"可以使用泛域名证书"),i("span",{lang:"zh-CN"},"可以使用泛域名证书")]),i("p",null,"如果你打算把所有服务器解析到一个域名上, 那么可以使用泛域名证书, 这样就不用为每一个节点都单独申请证书了.")],-1),gi=i("h3",{id:"配置证书",tabindex:"-1"},[s("配置证书 "),i("a",{class:"header-anchor",href:"#配置证书","aria-label":'Permalink to "配置证书"'},"​")],-1),yi=i("p",null,[s("准备好每个节点自己的 "),i("code",null,"mongod.pem"),s(", 把 CA 根证书 "),i("code",null,"isrgrootx1.pem"),s(" 拷贝给每一个节点. 我这里仍是直接挂载在了容器的 "),i("code",null,"/etc/mongo/"),s(" 目录.")],-1),Fi=i("p",null,"然后修改它们的配置文件:",-1),ui=i("div",{class:"language-yaml vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker has-diff vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"net"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 27017")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  bindIp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 0.0.0.0")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"  tls"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    mode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," requireTLS")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    certificateKeyFile"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /etc/mongo/mongod.pem")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    CAFile"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," /etc/mongo/isrgrootx1.pem")]),s(`
`),i("span",{class:"line diff add"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#F07178"}},"    allowConnectionsWithoutCertificates"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}}," true")])])]),i("button",{class:"collapse"})],-1),mi=i("p",null,[s("关于 "),i("code",null,"net.tls"),s(" 的配置详情参考:")],-1),Di=i("ul",null,[i("li",null,[i("a",{href:"https://www.mongodb.com/zh-cn/docs/manual/reference/configuration-options/#net.tls-options",target:"_blank",rel:"noreferrer"},"MongoDB TLS/SSL Configuration")])],-1),fi=i("p",null,"配置完证书后可以准备启动副本集了.",-1),_i=i("h2",{id:"启动副本集",tabindex:"-1"},[s("启动副本集 "),i("a",{class:"header-anchor",href:"#启动副本集","aria-label":'Permalink to "启动副本集"'},"​")],-1),Ci=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,"示例节点名"),i("th",null,"域名")])]),i("tbody",null,[i("tr",null,[i("td",null,"Server A"),i("td",null,"servera.mongodb.example.com")]),i("tr",null,[i("td",null,"Server B"),i("td",null,"serverb.mongodb.example.com")]),i("tr",null,[i("td",null,"Server C"),i("td",null,"serverc.mongodb.example.com")])])],-1),bi=i("p",null,[s("启动所有节点, 然后使用支持的客户端连接你打算作为主节点的节点, 使用 "),i("code",null,"rs.initiate()"),s(" 初始化副本集, 以 "),i("code",null,"Server A"),s(" 为例:")],-1),Ei=i("div",{class:"warning custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"WARNING"),i("span",{lang:"zh-CN"},"注意")]),i("p",null,[s("只在一个节点上执行 "),i("code",null,"rs.initiate()"),s("!")])],-1),vi=i("div",{class:"language-js vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"js"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"rs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#82AAFF"}},"initiate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"( "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"{")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}},"   _id "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"rs0"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},",")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}},"   members"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}}," [")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      {"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," _id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"servera.mongodb.example.com:27017"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}}," },")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      {"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," _id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"servera.mongodb.example.com:27017"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}}," },")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"      {"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," _id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#F78C6C"}}," 2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#F07178"}}," host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},":"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},' "'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"servera.mongodb.example.com:27017"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}}," }")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"   ]")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"}"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},")")])])]),i("button",{class:"collapse"})],-1),Ai=i("p",null,[s("或者, 也可以不向 "),i("code",null,"rs.initiate()"),s(" 传入配置, 而是初始化后再添加节点:")],-1),Bi=i("div",{class:"language-js vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"js"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"rs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#82AAFF"}},"initiate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"()")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"rs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#82AAFF"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"serverb.mongodb.example.com:27017"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"rs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#89DDFF"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#82AAFF"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#C3E88D"}},"serverc.mongodb.example.com:27017"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#89DDFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#EEFFFF"}},")")])])]),i("button",{class:"collapse"})],-1),wi=i("p",null,"参考:",-1),Si=i("ul",null,[i("li",null,[i("a",{href:"https://www.mongodb.com/zh-cn/docs/manual/tutorial/deploy-replica-set/#deploy-a-replica-set-in-the-terminal",target:"_blank",rel:"noreferrer"},"在终端中部署副本集")]),i("li",null,[i("a",{href:"https://www.mongodb.com/zh-cn/docs/manual/tutorial/expand-replica-set/#procedures",target:"_blank",rel:"noreferrer"},"将成员添加到自管理副本集")])],-1),xi=i("p",null,[s("如果你的操作都正确, 那这里应该已经启动成功了 😇. 使用 "),i("code",null,"rs.status()"),s(" 查看副本集状态:")],-1),Mi=i("figure",null,[i("img",{src:m,alt:"0",loading:"lazy",decoding:"async"})],-1),Ti=i("p",null,[i("code",null,"PRIMARY"),s(" 就是主节点, "),i("code",null,"SECONDARY"),s(" 是从节点.")],-1),Pi=i("p",null,[s("如果你发现有其他状态的节点, 可以查看 "),i("a",{href:"https://www.mongodb.com/zh-cn/docs/manual/reference/replica-states/",target:"_blank",rel:"noreferrer"},"副本集成员状态"),s(" 排查问题.")],-1),Ni=i("h2",{id:"连接副本集",tabindex:"-1"},[s("连接副本集 "),i("a",{class:"header-anchor",href:"#连接副本集","aria-label":'Permalink to "连接副本集"'},"​")],-1),Ri=i("p",null,"在上文, 我们连接到了主节点来初始化副本集, 它的连接字符串通常是像这样的:",-1),zi=i("div",{class:"language-text vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"text"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"mongodb://user:password@servera.mongodb.example.com:27017")])])]),i("button",{class:"collapse"})],-1),Ii=i("p",null,'但这样并不是连接到了 "整个" 副本集. 显然如果主节点挂了, 连接就会断开.',-1),Li=i("p",null,"其实 MongoDB 可以使用多服务器连接字符串, 例如:",-1),$i=i("div",{class:"language-text vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"text"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"mongodb://user:pssword@servera.mongodb.example.com:27017,serverb.mongodb.example.com:27017,serverc.mongodb.example.com:27017/?replicaSet=rs0")])])]),i("button",{class:"collapse"})],-1),Vi=i("p",null,"服务器之间用逗号分隔, 这样就可以连接到整个副本集了, 如果主节点挂了, 客户端会自动切换到其他节点.",-1),Oi=i("p",null,"但是这样的连接字符串太长了, 十分不方便, 这时可以使用 SRV 记录来连接.",-1),qi=i("h3",{id:"srv-记录",tabindex:"-1"},[s("SRV 记录 "),i("a",{class:"header-anchor",href:"#srv-记录","aria-label":'Permalink to "SRV 记录"'},"​")],-1),Wi=i("p",null,"SRV 记录（Service Record）是一种 DNS 记录, 用于指定特定服务在域中的主机名和端口号. 可以用于负载均衡和服务发现, 使客户端可以动态地查找提供特定服务的服务器.",-1),ji=i("p",null,"SRV 记录的设置需要在 DNS 服务商处设置, 以 Cloudflare 为例:",-1),Gi=i("figure",null,[i("img",{src:D,alt:"1",loading:"lazy",decoding:"async"})],-1),Qi=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,"选项"),i("th",null,"值"),i("th",null,"说明")])]),i("tbody",null,[i("tr",null,[i("td",null,"Name"),i("td",null,"_mongodb._tcp.mongodbsrv"),i("td",null,[s("SRV 记录的 Name 由服务名和域名组成, "),i("code",null,"_mongodb._tcp"),s(" 为服务名, 这里 "),i("code",null,"mongodbsrv"),s(" 是二级域名")])]),i("tr",null,[i("td",null,"Priority"),i("td",null,"0"),i("td",null,"优先级, 对于 MongoDB 副本集不需要特别设置")]),i("tr",null,[i("td",null,"Weight"),i("td",null,"1"),i("td",null,"权重, 对于 MongoDB 副本集不需要特别设置")]),i("tr",null,[i("td",null,"Port"),i("td",null,"27017"),i("td",null,"端口号")]),i("tr",null,[i("td",null,"Target"),i("td",null,"servera.mongodb.example.com"),i("td",null,"主机名, 填写解析到节点的域名")])])],-1),Xi=i("p",null,"要为每一个节点都设置 Name 相同的 SRV 记录哦.",-1),Ki=i("div",{class:"tip custom-block"},[i("p",{class:"custom-block-title"},[i("span",{lang:"en"},"TIP"),i("span",{lang:"zh-CN"},"提示")]),i("p",null,"设置 SRV 记录的域名和解析到节点使用的域名不一定要相同")],-1),Ui=i("p",null,[s("假设我们设置 SRV 记录的域名是 "),i("code",null,"example.com"),s(", 接下来就可以使用 "),i("code",null,"mongodb+srv"),s(" 的字符串格式来连接副本集了:")],-1),Yi=i("div",{class:"language-text vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"text"),i("pre",{class:"shiki shiki-themes github-light material-theme-darker vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"mongodb+srv://user:password@mongodbsrv.example.com/?replicaSet=rs0")])])]),i("button",{class:"collapse"})],-1),Zi=i("p",null,"🎉",-1),Ji=i("h2",{id:"faq",tabindex:"-1"},[s("FAQ "),i("a",{class:"header-anchor",href:"#faq","aria-label":'Permalink to "FAQ"'},"​")],-1),Hi=i("p",null,"一些其他的自问自答:",-1),is=i("ol",null,[i("li",null,[i("p",null,"为什么集群内认证不使用 X.509 证书?"),i("p",null,[s("太麻烦了, 使用 X.509 在节点间认证实际上是使用了基于角色的访问控制, 要在 "),i("code",null,"$external"),s(" 数据库中为节点配置角色, 还要自己维护 CA.")])]),i("li",null,[i("p",null,[s("配置中的 "),i("code",null,"tls.mode"),s(": "),i("code",null,"requireTLS"),s(" 和 "),i("code",null,"allowConnectionsWithoutCertificates"),s(": "),i("code",null,"true"),s(" 是不是冲突的?")]),i("p",null,[s("并不, "),i("code",null,"requireTLS"),s(" 是要求客户端使用 TLS 连接, "),i("code",null,"allowConnectionsWithoutCertificates"),s(" 是允许客户端不使用证书进行身份验证.")])]),i("li",null,[i("p",null,[s("为什么不配置 "),i("code",null,"net.tls.clusterFile"),s(" ?")]),i("p",null,"因为我们对集群内使用的是密钥文件 (keyfile) 验证."),i("p",null,[i("code",null,"clusterFile"),s(" 用于集群内使用 X.509 证书进行身份验证.")]),i("p",null,[s("即使集群内使用 X.509 证书验证, 不配置 "),i("code",null,"clusterFile"),s(", MongoDB 也会自动使用 "),i("code",null,"certificateKeyFile"),s(" 的证书进行验证.")])])],-1),ds={__name:"index",setup(ss,{expose:o}){const a=JSON.parse('{"title":"部署跨多数据中心分布的 MongoDB 副本集","description":"","frontmatter":{"title":"部署跨多数据中心分布的 MongoDB 副本集","date":"2024-08-18 19:05:10","updated":"2024-08-18 19:05:10","tags":["MongoDB","数据库","Docker"],"categories":"小技术","author":"Krau","copyright":true,"postTitleClass":"text-#00a043","pageTitleClass":"text-#00a043","end":true},"headers":[{"level":2,"title":"环境","slug":"环境","link":"#环境","children":[]},{"level":2,"title":"安装 MongoDB","slug":"安装-mongodb","link":"#安装-mongodb","children":[]},{"level":2,"title":"配置节点 keyfile","slug":"配置节点-keyfile","link":"#配置节点-keyfile","children":[{"level":3,"title":"生成 keyfile","slug":"生成-keyfile","link":"#生成-keyfile","children":[]},{"level":3,"title":"修改 keyfile 权限","slug":"修改-keyfile-权限","link":"#修改-keyfile-权限","children":[]}]},{"level":2,"title":"配置副本集认证","slug":"配置副本集认证","link":"#配置副本集认证","children":[]},{"level":2,"title":"配置 TLS","slug":"配置-tls","link":"#配置-tls","children":[{"level":3,"title":"准备证书","slug":"准备证书","link":"#准备证书","children":[]},{"level":3,"title":"配置证书","slug":"配置证书","link":"#配置证书","children":[]}]},{"level":2,"title":"启动副本集","slug":"启动副本集","link":"#启动副本集","children":[]},{"level":2,"title":"连接副本集","slug":"连接副本集","link":"#连接副本集","children":[{"level":3,"title":"SRV 记录","slug":"srv-记录","link":"#srv-记录","children":[]}]},{"level":2,"title":"FAQ","slug":"faq","link":"#faq","children":[]}],"relativePath":"pages/posts/deploy-mongodb-replica-set/index.md","path":"/home/runner/work/blog-source-valaxy/blog-source-valaxy/pages/posts/deploy-mongodb-replica-set/index.md","lastUpdated":1724243028000}'),h=g(),n=a.frontmatter||{};return h.meta.frontmatter=Object.assign(h.meta.frontmatter||{},a.frontmatter||{}),k("pageData",a),k("valaxy:frontmatter",n),globalThis.$frontmatter=n,o({frontmatter:{title:"部署跨多数据中心分布的 MongoDB 副本集",date:"2024-08-18 19:05:10",updated:"2024-08-18 19:05:10",tags:["MongoDB","数据库","Docker"],categories:"小技术",author:"Krau",copyright:!0,postTitleClass:"text-#00a043",pageTitleClass:"text-#00a043",end:!0}}),(t,ts)=>{const r=d;return y(),p(r,{frontmatter:c(n)},{"main-content-md":l(()=>[f,_,C,F(" more "),b,E,v,A,B,w,S,x,M,T,P,N,R,z,I,L,$,V,O,q,W,j,G,Q,X,K,U,Y,Z,J,H,ii,si,li,ti,ei,ai,ni,hi,ki,oi,ri,di,pi,ci,gi,yi,Fi,ui,mi,Di,fi,_i,Ci,bi,Ei,vi,Ai,Bi,wi,Si,xi,Mi,Ti,Pi,Ni,Ri,zi,Ii,Li,$i,Vi,Oi,qi,Wi,ji,Gi,Qi,Xi,Ki,Ui,Yi,Zi,Ji,Hi,is]),"main-header":l(()=>[e(t.$slots,"main-header")]),"main-header-after":l(()=>[e(t.$slots,"main-header-after")]),"main-nav":l(()=>[e(t.$slots,"main-nav")]),"main-content":l(()=>[e(t.$slots,"main-content")]),"main-content-after":l(()=>[e(t.$slots,"main-content-after")]),"main-nav-before":l(()=>[e(t.$slots,"main-nav-before")]),"main-nav-after":l(()=>[e(t.$slots,"main-nav-after")]),comment:l(()=>[e(t.$slots,"comment")]),footer:l(()=>[e(t.$slots,"footer")]),aside:l(()=>[e(t.$slots,"aside")]),"aside-custom":l(()=>[e(t.$slots,"aside-custom")]),default:l(()=>[e(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{ds as default};
