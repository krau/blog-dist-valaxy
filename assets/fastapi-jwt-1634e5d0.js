import{_ as D}from"./ValaxyMain.vue_vue_type_style_index_0_lang-368a8460.js";import{_ as F,p as y,c as i,w as o,o as A,b as s,d as l,e as n,a as C,r as a,f as d}from"./app-a1afda4c.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-9a0cba78.js";import"./YunCard.vue_vue_type_style_index_0_lang-4e8d3695.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-9d54a7af.js";const u="/photo/post-pics/fastapi-jwt/fastapi-jwt_03-22-11-28-26.webp",Qs=JSON.parse('{"title":"JWT 认证及其在 FastAPI 中的使用","description":"","frontmatter":{"title":"JWT 认证及其在 FastAPI 中的使用","date":"2023-03-22T10:59:53.000Z","updated":"2023-03-22T10:59:53.000Z","tags":["Python","代码","FastAPi"],"categories":["学习笔记"],"hide":null},"headers":[{"level":2,"title":"什么是 JWT","slug":"什么是-jwt","link":"#什么是-jwt","children":[{"level":3,"title":"JWT 有什么用","slug":"jwt-有什么用","link":"#jwt-有什么用","children":[]}]},{"level":2,"title":"FastAPI 实现 Bearer JWT 令牌验证","slug":"fastapi-实现-bearer-jwt-令牌验证","link":"#fastapi-实现-bearer-jwt-令牌验证","children":[{"level":3,"title":"数据库与模型","slug":"数据库与模型","link":"#数据库与模型","children":[]},{"level":3,"title":"对用户名和密码的校验与认证","slug":"对用户名和密码的校验与认证","link":"#对用户名和密码的校验与认证","children":[]},{"level":3,"title":"创建 jwt token","slug":"创建-jwt-token","link":"#创建-jwt-token","children":[]},{"level":3,"title":"提供登录并创建token的接口","slug":"提供登录并创建token的接口","link":"#提供登录并创建token的接口","children":[]},{"level":3,"title":"在其他接口中验证jwt token","slug":"在其他接口中验证jwt-token","link":"#在其他接口中验证jwt-token","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]},{"level":2,"title":"参考","slug":"参考","link":"#参考","children":[]}],"relativePath":"pages/posts/fastapi-jwt.md","path":"/home/runner/work/blog-source-valaxy/blog-source-valaxy/pages/posts/fastapi-jwt.md","lastUpdated":1685370144000}'),c=JSON.parse('{"title":"JWT 认证及其在 FastAPI 中的使用","description":"","frontmatter":{"title":"JWT 认证及其在 FastAPI 中的使用","date":"2023-03-22T10:59:53.000Z","updated":"2023-03-22T10:59:53.000Z","tags":["Python","代码","FastAPi"],"categories":["学习笔记"],"hide":null},"headers":[{"level":2,"title":"什么是 JWT","slug":"什么是-jwt","link":"#什么是-jwt","children":[{"level":3,"title":"JWT 有什么用","slug":"jwt-有什么用","link":"#jwt-有什么用","children":[]}]},{"level":2,"title":"FastAPI 实现 Bearer JWT 令牌验证","slug":"fastapi-实现-bearer-jwt-令牌验证","link":"#fastapi-实现-bearer-jwt-令牌验证","children":[{"level":3,"title":"数据库与模型","slug":"数据库与模型","link":"#数据库与模型","children":[]},{"level":3,"title":"对用户名和密码的校验与认证","slug":"对用户名和密码的校验与认证","link":"#对用户名和密码的校验与认证","children":[]},{"level":3,"title":"创建 jwt token","slug":"创建-jwt-token","link":"#创建-jwt-token","children":[]},{"level":3,"title":"提供登录并创建token的接口","slug":"提供登录并创建token的接口","link":"#提供登录并创建token的接口","children":[]},{"level":3,"title":"在其他接口中验证jwt token","slug":"在其他接口中验证jwt-token","link":"#在其他接口中验证jwt-token","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]},{"level":2,"title":"参考","slug":"参考","link":"#参考","children":[]}],"relativePath":"pages/posts/fastapi-jwt.md","path":"/home/runner/work/blog-source-valaxy/blog-source-valaxy/pages/posts/fastapi-jwt.md","lastUpdated":1685370144000}'),_={name:"pages/posts/fastapi-jwt.md",data(){return{data:c,frontmatter:c.frontmatter}},setup(){y("pageData",c)}},h={id:"什么是-jwt",tabindex:"-1"},f=s("p",null,"JWT: JSON Web Tokens,它是一种将 JSON 对象编码为没有空格，且难以理解的长字符串的标准。在具体上,它就是一段字符串,下面就是 FastAPI 文档中给出的例子",-1),m=s("div",{class:"language-txt"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}})])])])],-1),k=s("p",null,"抽象地把它看成是这样的",-1),g=s("div",{class:"language-txt"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"aaaaaaaaaaaa.bbbbbbbbbbbb.cccccccccccc")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}})])])])],-1),E=s("p",null,[l("jwt 由三个部分组成,这三个部分之间用点"),s("code",null,"."),l("拼接起来,这三个部分分别是")],-1),w=s("ul",null,[s("li",null,"Header --- 头,定义了 jwt 使用的算法等信息"),s("li",null,"Payload --- 载荷,存储有效信息的地方"),s("li",null,"Signature --- 签名,用于校验 jwt 令牌")],-1),b=s("p",null,"这三个部分中,只有第三个部分是无法还原的,前两个部分只是简单的进行了 base64 编码,把上面例子中的前两部分解码之后,看起来是这样的:",-1),j=s("p",null,"Header:",-1),T=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"alg"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"HS256"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"typ"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"JWT"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"})])])],-1),B=s("p",null,"alg 即为算法,这里使用了 HS256 算法",-1),v=s("p",null,"typ 即为类型,指明这里是一个 JWT 字符串",-1),x=s("p",null,"Payload",-1),I=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"sub"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"1234567890"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"John Doe"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"iat"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F78C6C"}},"1516239022")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),P=s("p",null,"可以看到 Payload 中存储了主要的信息",-1),J=s("div",{class:"tip custom-block"},[s("p",{class:"custom-block-title"},[s("span",{lang:"en"},"提示"),s("span",{lang:"zh-CN"},"提示")]),s("p",null,[l("根据 JWT 规范, Payload 中的 "),s("code",null,"sub"),l(" 是一个预定义的声明（Claim），表示JWT的主题（"),s("strong",null,"Subject"),l("）。它指定了JWT所代表的实体或主题，通常是用户或客户端应用程序。 "),s("code",null,"sub"),l("声明的值是字符串类型，通常是"),s("strong",null,"唯一"),l("标识用户或客户端应用程序的ID。")])],-1),W=s("p",null,"而 Signature 则是通过加盐加密得到的,加密由服务端实现",-1),N=s("div",{class:"tip custom-block"},[s("p",{class:"custom-block-title"},[s("span",{lang:"en"},"关于具体如何实现"),s("span",{lang:"zh-CN"},"关于具体如何实现")]),s("p",null,"参考下图"),s("p",null,[s("img",{src:u,alt:"图 1"})]),s("p",null,[l("即,把 header 和 payload 部分进行 base64编码,用点拼接起来,得到"),s("strong",null,"结果"),l(",把这个结果用我们设置的密钥和算法进行加盐加密,就得到了 Signature")])],-1),U={id:"jwt-有什么用",tabindex:"-1"},S=s("p",null,"其实它与 token ,cookie 的作用类似,就是用来免密码认证客户端",-1),O=s("p",null,"比如你去上学,学校是服务端,你是客户端.你完成学籍注册之后,学校发给你一个学生证,学生证就是你的 jwt 令牌.",-1),R=s("p",null,"你使用学校的很多服务,都要出示学生证.",-1),$=s("p",null,"而在实际业务中,jwt 令牌是有过期时间的,过期之后,需要客户端再次登录,获取新的 jwt",-1),M={id:"fastapi-实现-bearer-jwt-令牌验证",tabindex:"-1"},H=s("p",null,"需要安装以下几个包",-1),K=s("p",null,"python-jose，在 Python 中生成和校验 JWT 令牌",-1),G=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"pip"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"install"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"python-jose[cryptography]")]),l(`
`),s("span",{class:"line"})])])],-1),Y=s("p",null,"Passlib ,处理密码哈希",-1),Z=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"pip"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"install"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"passlib[bcrypt]")]),l(`
`),s("span",{class:"line"})])])],-1),V=s("div",{class:"warning custom-block"},[s("p",{class:"custom-block-title"},[s("span",{lang:"en"},"WARNING"),s("span",{lang:"zh-CN"},"注意")]),s("p",null,"密码哈希和 jwt 的加密不是同一个问题."),s("p",null,"哈希是指把特定内容（本例中为密码）转换为乱码形式的字节序列（其实就是字符串）。"),s("p",null,"每次传入完全相同的内容时（比如，完全相同的密码），返回的都是完全相同的乱码。"),s("p",null,"但这个乱码无法转换回传入的密码。"),s("p",null,"把密码进行哈希并存储是必要的安全措施")],-1),z=s("p",null,"先不考虑用户注册的问题,假设我们已经有了一个在数据库中的用户,那么这里的逻辑是这样的:",-1),L=s("ol",null,[s("li",null,"该用户通过用户名和密码登录"),s("li",null,"服务端对其进行校验和认证"),s("li",null,"完成认证后,用户拿到 jwt 令牌(token)"),s("li",null,"用户使用 jwt 令牌(token)访问其他服务")],-1),X=s("p",null,"所以,我们需要:",-1),Q=s("ol",null,[s("li",null,"一个存储了用户信息的数据库,其中密码存储的是哈希值"),s("li",null,"用户和 jwt 令牌(token)的模型"),s("li",null,"用于从数据库中获得用户信息,并验证的函数. 包括获取用户,哈希传入的密码,验证用户等"),s("li",null,"用于创建 jwt 令牌的函数"),s("li",null,"给用户登录并获取 jwt 令牌(token)的接口"),s("li",null,"验证用户的 jwt 是否正确和有效")],-1),q={id:"数据库与模型",tabindex:"-1"},ss=s("p",null,"呃,为了简便和偷懒,就用 FastAPI 文档中的假数据库吧",-1),ls=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"fake_users_db "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"johndoe"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"username"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"johndoe"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"full_name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"John Doe"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"email"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"johndoe@example.com"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hashed_password"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"disabled"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"False,")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),os=s("p",null,"定义之后要用到的模型",-1),es=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," pydantic "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," BaseModel")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," typing "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," Union")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"BaseModel"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    access_token"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    token_type"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"TokenData"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"BaseModel"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," Union"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None]"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"User"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"BaseModel"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    email"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," Union"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None]"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    full_name"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," Union"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None]"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    disabled"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," Union"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#FFCB6B"}},"bool"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None]"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserInDB"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"User"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    hashed_password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"})])])],-1),ns=s("p",null,[s("code",null,"Token"),l(" 模型用于在登录接口中指定 "),s("code",null,"response_model")],-1),ts=s("p",null,[s("code",null,"TokenData"),l(" 用于从 token 中获取数据")],-1),as=s("p",null,[s("code",null,"User"),l(" 即用户模型,供外部使用")],-1),cs=s("p",null,[s("code",null,"UserInDB"),l(" 是用户在数据库中的模型,它继承自 "),s("code",null,"User"),l(" 添加了 "),s("code",null,"hashed_password"),l(" 属性")],-1),ps=s("p",null,"这些模型在之后会用到",-1),rs={id:"对用户名和密码的校验与认证",tabindex:"-1"},Ds=s("p",null,"这部分比较简单,就是把用户输入的密码哈希之后和数据库中的对比就好了",-1),Fs=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," passlib"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"context "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," CryptContext")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"pwd_context "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"CryptContext"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"schemes"),s("span",{style:{color:"#89DDFF"}},"=["),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"bcrypt"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"],"),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"deprecated"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"auto"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"verify_password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"plain_password"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"hashed_password"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    校验密码是否正确")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    将传入的明文密码与数据库中的哈希值进行比对")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," pwd_context"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"verify"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"plain_password"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," hashed_password"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_password_hash"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"password"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"获取传入的密码的哈希值"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," pwd_context"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"hash"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"db"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"根据用户名从指定数据库中获取用户"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"in"),s("span",{style:{color:"#A6ACCD"}}," db"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        user_dict "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," db"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"username"),s("span",{style:{color:"#89DDFF"}},"]")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"UserInDB"),s("span",{style:{color:"#89DDFF"}},"(**"),s("span",{style:{color:"#82AAFF"}},"user_dict"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"authenticate_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"fake_db"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"身份验证, 返回用户对象或者 False"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"fake_db"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," username"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"not"),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"False")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"not"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"verify_password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"hashed_password"),s("span",{style:{color:"#89DDFF"}},"):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"False")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," user")]),l(`
`),s("span",{class:"line"})])])],-1),ys={id:"创建-jwt-token",tabindex:"-1"},is=s("p",null,"完成认证之后,就可以给用户创建 token 了",-1),As=s("p",null,"首先,定义 jwt 的加密密钥,加密算法和过期时间",-1),Cs=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"SECRET_KEY "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"ALGORITHM "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"HS256"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"ACCESS_TOKEN_EXPIRE_MINUTES "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"30")]),l(`
`),s("span",{class:"line"})])])],-1),ds=s("div",{class:"warning custom-block"},[s("p",{class:"custom-block-title"},[s("span",{lang:"en"},"注意"),s("span",{lang:"zh-CN"},"注意")]),s("p",null,"在实际项目中,jwt 的密钥不应该直接写在代码中,而是应该从环境变量中读取"),s("p",null,"例如,从环境变量中获取 SECRET_KEY"),s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," os")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"SECRET_KEY "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," os"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"environ"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"SECRET_KEY"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"})])])])],-1),us=s("p",null,"然后写创建 token 的函数",-1),_s=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," datetime "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," datetime"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," timedelta")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," jose "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," JWTError"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," jwt")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"create_access_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"data"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"dict"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"expires_delta"),s("span",{style:{color:"#89DDFF"}},"=None):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"创建 jwt token"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    to_encode "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," data"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"copy"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," expires_delta"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        expire "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," datetime"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"utcnow"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#A6ACCD"}}," expires_delta")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        expire "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," datetime"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"utcnow"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"timedelta"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"minutes"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F78C6C"}},"15"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    to_encode"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"update"),s("span",{style:{color:"#89DDFF"}},"({"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"exp"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#82AAFF"}}," expire"),s("span",{style:{color:"#89DDFF"}},"})")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 注意这里就用到了上面定义的 SECRET_KEY 和 ALGORITHM")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    encoded_jwt "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," jwt"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"encode"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"to_encode"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," SECRET_KEY"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"algorithm"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"ALGORITHM"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," encoded_jwt")]),l(`
`),s("span",{class:"line"})])])],-1),hs=s("p",null,"上面这个函数把传入的用于获取 jwt 的数据进行拷贝,并添加过期时间,然后 encode 得到 jwt token 并返回",-1),fs=s("p",null,"至此,我们完成了对用户的校验和认证,以及创建 jwt token 的功能,下面我们要在接口中使用它们",-1),ms={id:"提供登录并创建token的接口",tabindex:"-1"},ks=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," fastapi "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," Depends"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," FastAPI"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," HTTPException"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," status")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"from"),s("span",{style:{color:"#A6ACCD"}}," fastapi"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"security "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"import"),s("span",{style:{color:"#A6ACCD"}}," OAuth2PasswordBearer"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," OAuth2PasswordRequestForm")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"oauth2_scheme "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"OAuth2PasswordBearer"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"tokenUrl"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#82AAFF"}},"app"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"post"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"response_model"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"Token"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"async"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"login_for_access_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"form_data"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," OAuth2PasswordRequestForm "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Depends"),s("span",{style:{color:"#89DDFF"}},"()):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"登录并获取 token"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 通过用户名和密码获取用户, 如果用户不存在或者密码错误, 则抛出异常")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"authenticate_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"fake_users_db"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," form_data"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"username"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," form_data"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"password"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"not"),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"raise"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"HTTPException"),s("span",{style:{color:"#89DDFF"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 这部分是规范, 401 表示未授权")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"            "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"status_code"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"status"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"HTTP_401_UNAUTHORIZED"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"            "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"detail"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Incorrect username or password"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"            "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"headers"),s("span",{style:{color:"#89DDFF"}},"={"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"WWW-Authenticate"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"},")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"        "),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 上面已经相当于进行了用户身份验证, 所以这里可以直接创建 token")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    access_token_expires "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"timedelta"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"minutes"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"ACCESS_TOKEN_EXPIRE_MINUTES"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    access_token "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"create_access_token"),s("span",{style:{color:"#89DDFF"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"        "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"data"),s("span",{style:{color:"#89DDFF"}},"={"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"sub"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#82AAFF"}}," user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"username"),s("span",{style:{color:"#89DDFF"}},"},"),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"expires_delta"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"access_token_expires")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"    "),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 这里如何返回也是规范, 我们已在上面已经定义好了 response_model=Token")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," access_token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"token_type"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),gs=s("p",null,[s("code",null,'oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")'),l(" 声明了用户应该从哪个路由获取 token (相对路径),但是并未实现具体的功能")],-1),Es=s("p",null,[l("而我们自己写的 "),s("code",null,"login_for_access_token"),l(" 则是实现.")],-1),ws=s("p",null,"现在用户成功登录后,就拿到了 jwt token ,访问其他服务时,浏览器会携带 jwt token 一起发送请求",-1),bs=s("p",null,"我们只需要在其他接口中,对用户传来的 jwt token 进行验证即可",-1),js={id:"在其他接口中验证jwt-token",tabindex:"-1"},Ts=s("p",null,[l("比如我们有一个获取用户信息的接口 "),s("code",null,"read_users_me"),l(" ,那么,我们需要:")],-1),Bs=s("ol",null,[s("li",null,"获取用户传来的 token"),s("li",null,"验证 token 是否正确和有效"),s("li",null,"通过 token 获取当前的用户信息")],-1),vs=s("p",null,"首先,解密 jwt token ,获取当前用户:",-1),xs=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"async"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_current_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"token"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Depends"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"oauth2_scheme"),s("span",{style:{color:"#89DDFF"}},")):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"依赖函数, 用于获取当前用户"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 定义一个异常, 用于在用户身份验证失败时抛出")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    credentials_exception "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"HTTPException"),s("span",{style:{color:"#89DDFF"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"        "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"status_code"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"status"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"HTTP_401_UNAUTHORIZED"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"        "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"detail"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Could not validate credentials"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"        "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"headers"),s("span",{style:{color:"#89DDFF"}},"={"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"WWW-Authenticate"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"},")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"    "),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        payload "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," jwt"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"decode"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," SECRET_KEY"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"algorithms"),s("span",{style:{color:"#89DDFF"}},"=["),s("span",{style:{color:"#82AAFF"}},"ALGORITHM"),s("span",{style:{color:"#89DDFF"}},"])")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 从 payload 中获取 username")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# 关于 sub 的解释, 可以参考文档")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"str"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," payload"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"sub"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"is"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"raise"),s("span",{style:{color:"#A6ACCD"}}," credentials_exception")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        token_data "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"TokenData"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"username"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"username"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"except"),s("span",{style:{color:"#A6ACCD"}}," JWTError"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"raise"),s("span",{style:{color:"#A6ACCD"}}," credentials_exception")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"fake_users_db"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"username"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"token_data"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"username"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"is"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"None:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"raise"),s("span",{style:{color:"#A6ACCD"}}," credentials_exception")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," user")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"async"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"get_current_active_user"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"current_user"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," User "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Depends"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"get_current_user"),s("span",{style:{color:"#89DDFF"}},")):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"依赖函数, 用于获取当前活跃的用户,用到了上面的依赖函数 get_current_user")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    为什么 current_user 可以是 User 类型而不是 get_current_user 返回的 UserInDB 类型呢?")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    因为 UserInDB 类型是 User 类型的子类, 所以可以直接赋值给 User 类型的变量")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#A6ACCD"}}," current_user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#F07178"}},"disabled"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"raise"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"HTTPException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"status_code"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F78C6C"}},"400"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"detail"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Inactive user"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," current_user")]),l(`
`),s("span",{class:"line"})])])],-1),Is=s("p",null,[l("在 数据库与模型 中, 我们定义的 "),s("code",null,"TokenData"),l(" 就是这里要用的")],-1),Ps=s("p",null,[l("因为只是演示,所以这个 "),s("code",null,"TokenData"),l(" 类显得有点多此一举.")],-1),Js=s("p",null,[l("但是如果你需要传递多个 JWT 数据，或者有多个函数需要访问 JWT 数据，那么 "),s("code",null,"TokenData"),l(" 类可以方便地将这些数据打包在一起，并在函数之间传递它们。")],-1),Ws=s("p",null,"之后就可以在接口中利用依赖注入,验证用户请求",-1),Ns=s("div",{class:"language-python"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#82AAFF"}},"app"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/users/me/"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#82AAFF"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"response_model"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#82AAFF"}},"User"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"async"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"def"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"read_users_me"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"current_user"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," User "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Depends"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"get_current_active_user"),s("span",{style:{color:"#89DDFF"}},")):")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""'),s("span",{style:{color:"#676E95","font-style":"italic"}},"获取当前用户信息"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},'"""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," current_user")]),l(`
`),s("span",{class:"line"})])])],-1),Us={id:"总结",tabindex:"-1"},Ss=s("p",null,"JWT 是一种认证方式,它的本质是一段带有签名的字符串.",-1),Os=s("p",null,[l("在 Python 中,我们可以使用 "),s("code",null,"jwt"),l(" 模块来创建和解析 jwt token.")],-1),Rs=s("p",null,[l("在 FastAPI 中,我们可以使用 "),s("code",null,"OAuth2PasswordBearer"),l(" 来获取用户传来的 token,然后使用 "),s("code",null,"jwt"),l(" 模块来解析 token,从而获取用户信息.")],-1),$s={id:"参考",tabindex:"-1"};function Ms(t,Hs,Ks,Gs,p,Ys){const e=d,r=D;return A(),i(r,{frontmatter:p.frontmatter,data:p.data},{"main-content-md":o(()=>[s("h2",h,[l("什么是 JWT "),n(e,{class:"header-anchor",href:"#什么是-jwt","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),f,m,k,g,C(" more "),E,w,b,j,T,B,v,x,I,P,J,W,N,s("h3",U,[l("JWT 有什么用 "),n(e,{class:"header-anchor",href:"#jwt-有什么用","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),S,O,R,$,s("h2",M,[l("FastAPI 实现 Bearer JWT 令牌验证 "),n(e,{class:"header-anchor",href:"#fastapi-实现-bearer-jwt-令牌验证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),H,K,G,Y,Z,V,z,L,X,Q,s("h3",q,[l("数据库与模型 "),n(e,{class:"header-anchor",href:"#数据库与模型","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ss,ls,os,es,ns,ts,as,cs,ps,s("h3",rs,[l("对用户名和密码的校验与认证 "),n(e,{class:"header-anchor",href:"#对用户名和密码的校验与认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ds,Fs,s("h3",ys,[l("创建 jwt token "),n(e,{class:"header-anchor",href:"#创建-jwt-token","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),is,As,Cs,ds,us,_s,hs,fs,s("h3",ms,[l("提供登录并创建token的接口 "),n(e,{class:"header-anchor",href:"#提供登录并创建token的接口","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ks,gs,Es,ws,bs,s("h3",js,[l("在其他接口中验证jwt token "),n(e,{class:"header-anchor",href:"#在其他接口中验证jwt-token","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ts,Bs,vs,xs,Is,Ps,Js,Ws,Ns,s("h2",Us,[l("总结 "),n(e,{class:"header-anchor",href:"#总结","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ss,Os,Rs,s("h2",$s,[l("参考 "),n(e,{class:"header-anchor",href:"#参考","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("p",null,[n(e,{href:"https://jwt.io/introduction/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("JWT 官方文档")]),_:1})]),s("p",null,[n(e,{href:"https://fastapi.tiangolo.com/tutorial/security/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("FastAPI 官方文档 - 安全性")]),_:1})]),s("p",null,[n(e,{href:"https://fastapi.tiangolo.com/tutorial/dependencies/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("FastAPI 官方文档 - 依赖注入")]),_:1})])]),"main-header":o(()=>[a(t.$slots,"main-header")]),"main-header-after":o(()=>[a(t.$slots,"main-header-after")]),"main-nav":o(()=>[a(t.$slots,"main-nav")]),"main-content":o(()=>[a(t.$slots,"main-content")]),"main-content-after":o(()=>[a(t.$slots,"main-content-after")]),"main-nav-before":o(()=>[a(t.$slots,"main-nav-before")]),"main-nav-after":o(()=>[a(t.$slots,"main-nav-after")]),comment:o(()=>[a(t.$slots,"comment")]),footer:o(()=>[a(t.$slots,"footer")]),aside:o(()=>[a(t.$slots,"aside")]),"aside-custom":o(()=>[a(t.$slots,"aside-custom")]),default:o(()=>[a(t.$slots,"default")]),_:3},8,["frontmatter","data"])}const qs=F(_,[["render",Ms]]);export{Qs as __pageData,qs as default};
